<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Water Maps — Hopkinton Fire Department</title>
  <link rel="stylesheet" href="styles.css"/>
  <!-- Use LOCAL Leaflet assets (no CDN) -->
  <link rel="stylesheet" href="leaflet.min.css"/>
  <!-- Fallback CSP (server header wins if present) -->
  <meta http-equiv="Content-Security-Policy"
        content="default-src 'self';
                 img-src 'self' data: https://*.tile.openstreetmap.org;
                 style-src 'self' 'unsafe-inline';
                 script-src 'self' 'unsafe-inline';
                 connect-src 'self' https://nominatim.openstreetmap.org;">
  <style>
    .map-shell { position: relative; border-radius: 12px; overflow: visible; }
    #map { width: 100%; height: 70vh; min-height: 420px; z-index: 1; }
    .leaflet-container { z-index: 1; }

    .map-search, .map-layers, .map-legend {
      position: absolute; z-index: 10000;
      background: rgba(255,255,255,0.96);
      border-radius: 10px;
      box-shadow: 0 6px 18px rgba(0,0,0,0.14);
    }
    .map-search { top: 12px; left: 12px; right: 12px; display: flex; gap: 8px; align-items: center; padding: 8px; }
    .map-search input[type="text"] { flex: 1 1 auto; padding: 10px 12px; border-radius: 8px; border: 1px solid #d1d5db; font-size: 16px; outline: none; }
    .map-search button, .map-search select { flex: 0 0 auto; padding: 10px 12px; border-radius: 8px; border: 1px solid #d1d5db; background: #fff; cursor: pointer; }

    .map-layers { bottom: 12px; left: 12px; padding: 10px 12px; display: grid; grid-auto-rows: minmax(28px, auto); gap: 6px; font-size: 14px; }
    .layer-toggle { user-select: none; }

    .map-legend { bottom: 12px; right: 12px; padding: 10px 12px; font-size: 14px; min-width: 180px; }
    .legend-title { font-weight: 700; margin-bottom: 6px; }
    .legend-item { display: flex; align-items: center; gap: 8px; margin: 4px 0; }
    .legend-swatch { width: 14px; height: 14px; border-radius: 3px; display: inline-block; }

    @media (max-width: 640px) {
      #map { height: 60vh; min-height: 360px; }
      .map-search { right: auto; max-width: calc(100% - 24px); }
      .map-layers, .map-legend { font-size: 13px; }
    }
  </style>
</head>
<body>
  <header class="site-header">
    <div class="container">
      <nav class="nav">
        <a class="nav__brand" href="home.html">Hopkinton Fire Department</a>
        <ul class="nav__links">
          <li><a href="home.html">Home</a></li>
          <li class="dropdown">
            <a class="dropbtn" href="apparatus.html">Apparatus ▾</a>
            <ul class="dropdown-content">
              <li class="dropdown-submenu">
                <a class="submenu-btn" href="engine1.html">Engine 1 ▸</a>
                <ul class="submenu">
                  <li><a class="active" href="engine1.html">Overview</a></li>
                  <li><a href="engine1-specifications.html">Specifications</a></li>
                  <li><a href="engine1-hose.html">Hose</a></li>
                  <li><a href="engine1-equipment.html">Equipment</a></li>
                  <li><a href="engine1-foam.html">Foam Operations</a></li>
                </ul>
              </li>
              <li class="dropdown-submenu">
                <a class="submenu-btn" href="engine2.html">Engine 2 ▸</a>
                <ul class="submenu">
                  <li><a href="engine2.html">Overview</a></li>
                  <li><a href="engine2-specifications.html">Specifications</a></li>
                  <li><a href="engine2-hose.html">Hose</a></li>
                  <li><a href="engine2-equipment.html">Equipment</a></li>
                  <li><a href="engine2-foam.html">Foam Operations</a></li>
                </ul>
              </li>
              <li class="dropdown-submenu">
                <a class="submenu-btn" href="ladder1.html">Ladder 1 ▸</a>
                <ul class="submenu">
                  <li><a href="ladder1.html">Overview</a></li>
                  <li><a href="ladder1-specifications.html">Specifications</a></li>
                  <li><a href="ladder1-hose.html">Hose</a></li>
                  <li><a href="ladder1-equipment.html">Equipment</a></li>
                  <li><a href="ladder1-foam.html">Foam Operations</a></li>
                </ul>
              </li>
              <li class="dropdown-submenu">
                <a class="submenu-btn" href="tanker3.html">Tanker 3 ▸</a>
                <ul class="submenu">
                  <li><a href="tanker3.html">Overview</a></li>
                  <li><a href="tanker3-specifications.html">Specifications</a></li>
                  <li><a href="tanker3-hose.html">Hose</a></li>
                  <li><a href="tanker3-equipment.html">Equipment</a></li>
                  <li><a href="tanker3-foam.html">Foam Operations</a></li>
                </ul>
              </li>
              <li class="dropdown-submenu">
                <a class="submenu-btn" href="rescue1.html">Rescue 1 ▸</a>
                <ul class="submenu">
                  <li><a href="rescue1.html">Overview</a></li>
                  <li><a href="rescue1-specifications.html">Specifications</a></li>
                  <li><a href="rescue1-hose.html">Hose</a></li>
                  <li><a href="rescue1-equipment.html">Equipment</a></li>
                  <li><a href="rescue1-foam.html">Foam Operations</a></li>
                </ul>
              </li>
              <li class="dropdown-submenu">
                <a class="submenu-btn" href="brush11.html">Brush 11 ▸</a>
                <ul class="submenu">
                  <li><a href="brush11.html">Overview</a></li>
                  <li><a href="brush11-specifications.html">Specifications</a></li>
                  <li><a href="brush11-hose.html">Hose</a></li>
                  <li><a href="brush11-equipment.html">Equipment</a></li>
                  <li><a href="brush11-foam.html">Foam Operations</a></li>
                </ul>
              </li>
              <li><a href="brush6.html">Brush 6</a></li>
              <li><a href="squad1.html">Squad 1</a></li>
              <li><a href="boats.html">Boats</a></li>
              <li><a href="ambulance1.html">Ambulance 1</a></li>
              <li><a href="ambulance2.html">Ambulance 2</a></li>
            </ul>
          </li>
          <li class="dropdown">
            <a class="dropbtn" href="maps.html">Maps ▾</a>
            <ul class="dropdown-content">
              <li><a class="active" href="water-maps.html">Water Maps</a></li>
              <li><a href="highway-map.html">Highway Map</a></li>
              <li><a href="trail-maps.html">Trail Maps</a></li>
            </ul>
          </li>
          <li><a href="run-cards.html">Run Cards</a></li>
          <li><a href="erg.html">ERG</a></li>
          <li><a href="administrative.html">Administrative</a></li>
        </ul>
      </nav>
    </div>
  </header>

  <main>
    <section class="container">
      <h2 class="section-title">Water Maps</h2>
      <div class="map-shell">
        <div class="map-search">
          <input id="map-search-input" type="text" placeholder="Search address, intersection, place…" aria-label="Search address"/>
          <button id="map-search-btn" type="button">Search</button>
          <select id="zoom-select" title="Zoom to layer">
            <option value="">Zoom to…</option>
            <option value="hydrants">Hydrants</option>
            <option value="cisterns">Cisterns</option>
            <option value="outdistrict">Out of Hydrant District</option>
            <option value="hfd">All HFD Layers</option>
            <option value="all">Entire Map</option>
          </select>
        </div>

        <div id="map" role="region" aria-label="Interactive water map"></div>

        <div class="map-layers">
          <label class="layer-toggle"><input type="checkbox" id="layer-hydrants" checked> Hydrants</label>
          <label class="layer-toggle"><input type="checkbox" id="layer-cisterns" checked> Cisterns</label>
          <label class="layer-toggle"><input type="checkbox" id="layer-outdistrict" checked> Out of Hydrant District</label>
          <label class="layer-toggle"><input type="checkbox" id="layer-hfd" checked> All HFD Layers</label>
        </div>

        <div class="map-legend">
          <div class="legend-title">Legend</div>
          <div class="legend-item"><span class="legend-swatch" style="background:#e11d48;"></span>Hydrants</div>
          <div class="legend-item"><span class="legend-swatch" style="background:#059669;"></span>Cisterns</div>
          <div class="legend-item"><span class="legend-swatch" style="background:#b91c1c;"></span>Out of Hydrant District</div>
          <div class="legend-item"><span class="legend-swatch" style="background:#7c3aed;"></span>All HFD Layers</div>
        </div>
      </div>
    </section>
  </main>

  <footer class="site-footer">
    <div class="container">
      <p><strong>© 2025 Hopkinton Fire Department</strong></p>
    </div>
  </footer>

  <!-- Use LOCAL Leaflet assets -->
  <script src="leaflet.min.js"></script>
  <script>
    if (!window.L) { alert('Leaflet failed to load. Make sure leaflet.min.js is present next to this HTML.'); }
    const layerInfo = {
      "Hydrants": {"id":"hydrants","file":"hopkinton_fire_department___hydrants.geojson","color":"#e11d48"},
      "Cisterns": {"id":"cisterns","file":"hopkinton_fire_department___cisterns.geojson","color":"#059669"},
      "Out of Hydrant District": {"id":"outdistrict","file":"out_of_hydrant_district.geojson","color":"#b91c1c"},
      "All HFD Layers": {"id":"hfd","file":"hopkinton_fire_department.geojson","color":"#7c3aed"}
    };

    const map = L.map('map').setView([42.228534, -71.533708], 12);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '&copy; OpenStreetMap contributors'
    }).addTo(map);

    const layers = {};
    const layerBounds = {};
    const allBounds = L.latLngBounds([]);

    function svgIcon(hex) {
      const svg = `<svg xmlns='http://www.w3.org/2000/svg' width='20' height='20' viewBox='0 0 24 24'>
          <circle cx='12' cy='12' r='7' fill='${hex}' stroke='white' stroke-width='2'/>
        </svg>`;
      return L.icon({
        iconUrl: 'data:image/svg+xml;utf8,' + svg,
        iconSize: [20,20], iconAnchor: [10,10], popupAnchor: [0,-10]
      });
    }

    function pointStyleFactory(hex, useMarker=false) {
      if (useMarker) { const icon = svgIcon(hex); return (f, latlng) => L.marker(latlng, { icon }); }
      return (f, latlng) => L.circleMarker(latlng, { radius: 5, weight: 1, color: hex, fillColor: hex, fillOpacity: 0.85 });
    }

    function defaultPopup(feature, layer) {
      const p = feature.properties||{};
      const name = p.name ? `<strong>${p.name}</strong>` : '';
      const desc = p.description ? `<div>${p.description}</div>` : '';
      const rest = Object.entries(p).filter(([k])=>k!=='name'&&k!=='description').map(([k,v])=>`<div><em>${k}</em>: ${v}</div>`).join('');
      const html = name + desc + (rest?`<div style="margin-top:6px">${rest}</div>`:'');
      if (html) layer.bindPopup(html);
    }

    Object.entries(layerInfo).forEach(([label, cfg]) => {
      fetch(cfg.file).then(r => r.json()).then(geo => {
        const isPoints = geo.features && geo.features.some(f => f.geometry && f.geometry.type === 'Point');
        const styleFn = (f) => ({ color: cfg.color, weight: 2, fillOpacity: 0.08 });
        const layer = L.geoJSON(geo, { pointToLayer: isPoints ? pointStyleFactory(cfg.color, false) : undefined, style: styleFn, onEachFeature: defaultPopup });
        layers[cfg.id] = layer.addTo(map);

        const b = L.latLngBounds([]);
        layer.getLayers().forEach(l => { if (l.getLatLng) b.extend(l.getLatLng()); else if (l.getBounds) b.extend(l.getBounds()); });
        if (b.isValid()) { layerBounds[cfg.id] = b; allBounds.extend(b); }

        const cb = document.getElementById('layer-' + cfg.id);
        if (cb) cb.addEventListener('change', (e) => { if (e.target.checked) layers[cfg.id].addTo(map); else map.removeLayer(layers[cfg.id]); });
      });
    });

    function doSearch(q) {
      if (!q) return;
      const url = `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(q)}&limit=1`;
      fetch(url, { headers: {'Accept': 'application/json'}, referrerPolicy: 'no-referrer' }).then(r => r.json()).then(arr => {
        if (!arr || !arr.length) { alert('Address not found'); return; }
        const r0 = arr[0]; const lat = parseFloat(r0.lat), lon = parseFloat(r0.lon);
        map.setView([lat, lon], 16);
        L.marker([lat, lon]).addTo(map).bindPopup(r0.display_name).openPopup();
      }).catch(()=>alert('Search failed'));
    }
    document.getElementById('map-search-btn').addEventListener('click', () => doSearch(document.getElementById('map-search-input').value.trim()));
    document.getElementById('map-search-input').addEventListener('keydown', (e) => { if (e.key === 'Enter') { e.preventDefault(); doSearch(e.target.value.trim()); } });

    document.getElementById('zoom-select').addEventListener('change', (e) => {
      const val = e.target.value; if (!val) return;
      if (val === 'all') { if (allBounds.isValid()) map.fitBounds(allBounds.pad(0.05)); return; }
      const b = layerBounds[val]; if (b && b.isValid()) map.fitBounds(b.pad(0.05));
    });
  </script>
</body>
</html>
