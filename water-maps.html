<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Water Maps — Hopkinton Fire Department</title>
  <link rel="stylesheet" href="styles.css"/>
  <link rel="stylesheet" href="leaflet.min.css"/>
  <meta http-equiv="Content-Security-Policy"
        content="default-src 'self';
                 img-src 'self' data: https://*.tile.openstreetmap.org;
                 style-src 'self' 'unsafe-inline';
                 script-src 'self' 'unsafe-inline';
                 connect-src 'self' https://nominatim.openstreetmap.org;">
  <style>
    .map-shell { position: relative; border-radius: 12px; overflow: visible; }
    #map { width: 100%; height: 70vh; min-height: 420px; z-index: 1; }
    .map-search, .map-layers, .map-legend, .map-toast {
      position: absolute; z-index: 10000; background: rgba(255,255,255,0.96);
      border-radius: 10px; box-shadow: 0 6px 18px rgba(0,0,0,0.14);
    }
    .map-search { top: 12px; left: 12px; right: 12px; display: flex; gap: 8px; align-items: center; padding: 8px; }
    .map-search input { flex: 1 1 auto; padding: 10px 12px; border-radius: 8px; border: 1px solid #d1d5db; font-size: 16px; }
    .map-search button, .map-search select { padding: 10px 12px; border-radius: 8px; border: 1px solid #d1d5db; background: #fff; }
    .map-layers { bottom: 12px; left: 12px; padding: 10px 12px; display: grid; gap: 6px; font-size: 14px; }
    .map-legend { bottom: 12px; right: 12px; padding: 10px 12px; font-size: 14px; min-width: 180px; }
    .legend-title { font-weight: 700; margin-bottom: 6px; }
    .legend-item { display: flex; align-items: center; gap: 8px; margin: 4px 0; }
    .legend-swatch { width: 14px; height: 14px; border-radius: 3px; display: inline-block; }
    .map-toast { top: 12px; left: 50%; transform: translateX(-50%); padding: 10px 14px; color:#fff; background:#b91c1c; display:none; }
    @media (max-width: 640px) { #map { height: 60vh; min-height: 360px; } }
  </style>
</head>
<body>
  <header class="site-header">
    <div class="container">
      <nav class="nav">
        <a class="nav__brand" href="home.html">Hopkinton Fire Department</a>
        <ul class="nav__links">
          <li><a href="home.html">Home</a></li>
          <li class="dropdown">
            <a class="dropbtn" href="maps.html">Maps ▾</a>
            <ul class="dropdown-content">
              <li><a class="active" href="water-maps.html">Water Maps</a></li>
            </ul>
          </li>
        </ul>
      </nav>
    </div>
  </header>

  <main>
    <section class="container">
      <h2 class="section-title">Water Maps</h2>
      <div class="map-shell">
        <div class="map-search">
          <input id="map-search-input" type="text" placeholder="Search address, intersection, place…" aria-label="Search address"/>
          <button id="map-search-btn" type="button">Search</button>
          <select id="zoom-select" title="Zoom to layer">
            <option value="">Zoom to…</option>
            <option value="hydrants">Hydrants</option>
            <option value="cisterns">Cisterns</option>
            <option value="outdistrict">Out of Hydrant District</option>
            <option value="hfd">All HFD Layers (optional)</option>
            <option value="all">Entire Map</option>
          </select>
        </div>

        <div id="map" role="region" aria-label="Interactive water map"></div>

        <div class="map-layers">
          <label class="layer-toggle"><input type="checkbox" id="layer-hydrants" checked> Hydrants</label>
<label class="layer-toggle"><input type="checkbox" id="layer-cisterns" checked> Cisterns</label>
<label class="layer-toggle"><input type="checkbox" id="layer-outdistrict" checked> Out of Hydrant District</label>
<label class="layer-toggle"><input type="checkbox" id="layer-hfd" > All HFD Layers (optional)</label>
        </div>

        <div class="map-legend">
          <div class="legend-title">Legend</div>
          <div class="legend-item"><span class="legend-swatch" style="background:#e11d48;"></span>Hydrants</div>
<div class="legend-item"><span class="legend-swatch" style="background:#059669;"></span>Cisterns</div>
<div class="legend-item"><span class="legend-swatch" style="background:#b91c1c;"></span>Out of Hydrant District</div>
<div class="legend-item"><span class="legend-swatch" style="background:#7c3aed;"></span>All HFD Layers (optional)</div>
        </div>
        <div id="toast" class="map-toast"></div>
      </div>
    </section>
  </main>

  <footer class="site-footer">
    <div class="container">
      <p><strong>© 2025 Hopkinton Fire Department</strong></p>
    </div>
  </footer>

  <script src="leaflet.min.js"></script>
  <script>
    // If your GeoJSONs live under /data/, set PATH_PREFIX = 'data/'
    const PATH_PREFIX = '';
    const layerInfo = {"Hydrants": {"id": "hydrants", "file": "hopkinton_fire_department___hydrants.geojson", "color": "#e11d48", "checked": true}, "Cisterns": {"id": "cisterns", "file": "hopkinton_fire_department___cisterns.geojson", "color": "#059669", "checked": true}, "Out of Hydrant District": {"id": "outdistrict", "file": "out_of_hydrant_district.geojson", "color": "#b91c1c", "checked": true}, "All HFD Layers (optional)": {"id": "hfd", "file": "hopkinton_fire_department.geojson", "color": "#7c3aed", "checked": false}};

    const map = L.map('map').setView([42.228534, -71.533708], 12);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: '&copy; OpenStreetMap contributors' }).addTo(map);

    const layers = {};
    const layerBounds = {};
    const allBounds = L.latLngBounds([]);

    function toast(msg) {
      const t = document.getElementById('toast'); t.textContent = msg; t.style.display = 'block';
      setTimeout(() => t.style.display = 'none', 3500);
    }

    function svgIcon(hex) {
      const svg = `<svg xmlns='http://www.w3.org/2000/svg' width='20' height='20' viewBox='0 0 24 24'>
          <circle cx='12' cy='12' r='7' fill='${hex}' stroke='white' stroke-width='2'/>
        </svg>`;
      return L.icon({
        iconUrl: 'data:image/svg+xml;utf8,' + svg,
        iconSize: [20,20], iconAnchor: [10,10], popupAnchor: [0,-10]
      });
    }
    function pointStyleFactory(hex, useMarker=false) {
      if (useMarker) { const icon = svgIcon(hex); return (f, latlng) => L.marker(latlng, { icon }); }
      return (f, latlng) => L.circleMarker(latlng, { radius: 5, weight: 1, color: hex, fillColor: hex, fillOpacity: 0.85 });
    }
    function defaultPopup(feature, layer) {
      const p = feature.properties||{};
      const name = p.name ? `<strong>${p.name}</strong>` : '';
      const desc = p.description ? `<div>${p.description}</div>` : '';
      const rest = Object.entries(p).filter(([k])=>k!=='name'&&k!=='description').map(([k,v])=>`<div><em>${k}</em>: ${v}</div>`).join('');
      const html = name + desc + (rest?`<div style="margin-top:6px">${rest}</div>`:'');
      if (html) layer.bindPopup(html);
    }

    function loadLayer(label, cfg) {
      const url = PATH_PREFIX + cfg.file + '?v=' + Date.now();
      fetch(url).then(r => {
        if (!r.ok) throw new Error('HTTP ' + r.status + ' for ' + cfg.file);
        return r.json();
      }).then(geo => {
        const feats = Array.isArray(geo.features) ? geo.features : [];
        if (!feats.length) toast(label + ': no features in data');
        const isPoints = feats.some(f => f.geometry && f.geometry.type === 'Point');
        const layer = L.geoJSON(geo, {
          pointToLayer: isPoints ? pointStyleFactory(cfg.color, false) : undefined,
          style: () => ({ color: cfg.color, weight: 2, fillOpacity: 0.08 }),
          onEachFeature: defaultPopup
        });
        layers[cfg.id] = layer;
        if (cfg.checked) layer.addTo(map);

        const b = L.latLngBounds([]);
        layer.getLayers().forEach(l => { if (l.getLatLng) b.extend(l.getLatLng()); else if (l.getBounds) b.extend(l.getBounds()); });
        if (b.isValid()) { layerBounds[cfg.id] = b; allBounds.extend(b); }
      }).catch(err => {
        // Only show a toast for optional layer (All HFD) or show concise message
        const isOptional = label.includes('(optional)');
        const msg = isOptional ? ('Optional layer skipped: ' + label) : ('Failed to load ' + label + ': ' + err.message);
        toast(msg);
        console.error('Layer load error:', cfg.file, err);
      }).finally(() => { /* no-op */ });
    }

    Object.entries(layerInfo).forEach(([label, cfg]) => loadLayer(label, cfg));

    document.getElementById('map-search-btn').addEventListener('click', () => {
      const q = document.getElementById('map-search-input').value.trim();
      if (!q) return;
      const url = `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(q)}&limit=1`;
      fetch(url, { headers: {'Accept': 'application/json'}, referrerPolicy: 'no-referrer' }).then(r => r.json()).then(arr => {
        if (!arr || !arr.length) { toast('Address not found'); return; }
        const r0 = arr[0]; const lat = parseFloat(r0.lat), lon = parseFloat(r0.lon);
        map.setView([lat, lon], 16);
        L.marker([lat, lon]).addTo(map).bindPopup(r0.display_name).openPopup();
      }).catch(()=>toast('Search failed'));
    });
    document.getElementById('map-search-input').addEventListener('keydown', (e) => { if (e.key === 'Enter') { e.preventDefault(); document.getElementById('map-search-btn').click(); } });

    document.getElementById('zoom-select').addEventListener('change', (e) => {
      const val = e.target.value; if (!val) return;
      if (val === 'all') { if (allBounds.isValid()) map.fitBounds(allBounds.pad(0.05)); return; }
      const b = layerBounds[val]; if (b && b.isValid()) map.fitBounds(b.pad(0.05));
    });

    // Wire checkboxes
    Object.entries(layerInfo).forEach(([label, cfg]) => {
      const cb = document.getElementById('layer-' + cfg.id);
      if (!cb) return;
      cb.addEventListener('change', (e) => {
        const layer = layers[cfg.id]; if (!layer) return;
        if (e.target.checked) layer.addTo(map); else map.removeLayer(layer);
      });
    });
  </script>
</body>
</html>
